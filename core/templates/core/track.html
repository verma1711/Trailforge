{% extends 'base.html' %}
{% load static %}
{% block content %}
<main class="max-w-6xl mx-auto px-4 mt-[80px]">
  <div class="rounded-2xl overflow-hidden bg-card">
    <img src="{% static 'images/hero.jpg' %}" class="w-full h-64 object-cover" alt="Track cover" />
    <div class="p-6 bg-gray-800">
      <div class="flex items-center justify-between">
        <h1 class="text-3xl font-bold">{{tracks.track_name}}</h1>
        <span class="text-xs px-2 py-1 rounded-full border border-emerald-400 text-emerald-300">{{tracks.get_track_difficulty_display}}</span>
      </div>
      <p class="text-gray-400 mt-2">{{tracks.track_locality}}, {{tracks.track_city}}, {{tracks.track_state}}</p>
      <p class="mt-4 text-gray-300">{{tracks.track_description}}</p>
    </div>
  </div>

  <section class="mt-10">     
    <div class="flex items-center justify-between mb-3">
      <h2 class="text-2xl font-semibold">Available Sessions</h2>
      <div class="text-sm text-gray-300">
        Selected: <span id="selectedDateLabel" class="font-semibold text-emerald-300">All Dates</span>
      </div>
    </div>

    <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 mb-6">
      <div class="flex items-center justify-between mb-3">
        <button id="calPrev" class="px-3 py-1 rounded bg-gray-700 hover:bg-gray-600 text-sm">Prev</button>
        <div id="calTitle" class="font-semibold"></div>
        <button id="calNext" class="px-3 py-1 rounded bg-gray-700 hover:bg-gray-600 text-sm">Next</button>
      </div>
      <div class="grid grid-cols-7 gap-1 text-center text-xs text-gray-400 mb-1">
        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
      </div>
      <div id="calGrid" class="grid grid-cols-7 gap-1"></div>
      <p class="mt-3 text-xs text-gray-400">Tip: click a date to filter the sessions below. Click the same date again to clear.</p>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-left text-sm" id="sessionsTable">
        <thead>
          <tr class="border-b border-gray-700">
            <th class="py-2">Date</th>
            <th class="py-2">Time</th>
            <th class="py-2">Price</th>
            <th class="py-2">Action</th>
          </tr>
        </thead>
        <tbody id="sessionsBody">
          {% for bookings in booking %}
          <tr data-date="{{ bookings.booking_date|date:'Y-m-d' }}">
            <td class="py-2">{{bookings.booking_date}}</td>
            <td class="py-2">{{bookings.get_booking_time_display}}</td>
            <td class="py-2">0</td>
            {% if bookings.booking_status %}
            <td class="py-2">
              <a href="checkout.html" class="bg-emerald-500 hover:bg-emerald-600 text-gray-900 font-semibold px-3 py-1 rounded-md text-xs">Book</a>
            </td>
            {% else %}
            <td class="py-2">
              <a href="#" class="bg-red-500 text-gray-900 font-semibold px-3 py-1 rounded-md text-xs">Not Available</a>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <div id="emptyState" class="hidden text-center py-10 text-gray-400">No sessions for the selected date.</div>
    </div>
  </section>
  <section class="mt-10 mb-16 grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <h2 class="text-2xl font-semibold mb-4">Where to find it</h2>
      <p class="text-gray-300">{{tracks.track_name}}<br>{{tracks.track_locality}}, {{tracks.track_city}}. {{tracks.track_state}}</p>
      <p class="text-gray-400 mt-2">{{tracks.track_location_extra}}</p>
    </div>
    <div>
      <div class="w-full h-48 bg-gray-700 rounded-xl flex items-center justify-center">
        <span class="text-gray-400">{{tracks.track_map_url}}</span>
      </div>
    </div>
  </section>
</main>

<script>
(function(){
  function iso(y,m,d){return y+"-"+String(m).padStart(2,"0")+"-"+String(d).padStart(2,"0")}
  function title(y,m){return new Date(y,m-1,1).toLocaleString(undefined,{month:"long",year:"numeric"})}
  const today=new Date();let year=today.getFullYear();let month=today.getMonth()+1;let selected=null
  const calTitle=document.getElementById("calTitle")
  const calGrid=document.getElementById("calGrid")
  const label=document.getElementById("selectedDateLabel")
  const prev=document.getElementById("calPrev")
  const next=document.getElementById("calNext")
  const tbody=document.getElementById("sessionsBody")
  const empty=document.getElementById("emptyState")

  function build(y,m){
    calTitle.textContent=title(y,m)
    calGrid.innerHTML=""
    const first=new Date(y,m-1,1)
    const start=first.getDay()
    const last=new Date(y,m,0).getDate()
    for(let i=0;i<start;i++){calGrid.appendChild(document.createElement("div"))}
    for(let d=1;d<=last;d++){
      const isoStr=iso(y,m,d)
      const btn=document.createElement("button")
      btn.textContent=d
      btn.className="h-10 w-full rounded text-sm"
      if(selected===isoStr){btn.classList.add("bg-emerald-500","text-gray-900","font-semibold")}
      else{btn.classList.add("bg-gray-800","hover:bg-gray-700")}
      const dateObj=new Date(y,m-1,d)
      if(dateObj<new Date().setHours(0,0,0,0)){btn.disabled=true;btn.className="h-10 w-full rounded text-sm bg-gray-800/60 text-gray-500"}
      btn.onclick=function(){
        if(selected===isoStr){selected=null;label.textContent="All Dates"}else{selected=isoStr;label.textContent=d+" "+new Date(y,m-1,d).toLocaleString(undefined,{month:"short",year:"numeric"})}
        filter();build(year,month)
      }
      calGrid.appendChild(btn)
    }
  }

  function filter(){
    const rows=[...tbody.querySelectorAll("tr")]
    let shown=0
    rows.forEach(r=>{const show=!selected||r.dataset.date===selected;r.style.display=show?"":"none";if(show)shown++})
    empty.classList.toggle("hidden",shown>0)
  }

  prev.onclick=function(){const d=new Date(year,month-2,1);year=d.getFullYear();month=d.getMonth()+1;build(year,month)}
  next.onclick=function(){const d=new Date(year,month,1);year=d.getFullYear();month=d.getMonth()+1;build(year,month)}
  build(year,month);filter()
})()
</script>
{% endblock content %}
